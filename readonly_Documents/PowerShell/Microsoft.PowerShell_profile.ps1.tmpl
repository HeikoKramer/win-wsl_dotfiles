# Generated by chezmoi from common/shortcuts.yml

$ErrorActionPreference = "Stop"
Set-Location $HOME
if (-not $env:DOTFILES) { $env:DOTFILES = "E:\Configs\dotfiles" }

if (-not $env:DOTFILES_PROFILE_AUTOUPDATED) {
  $env:DOTFILES_PROFILE_AUTOUPDATED = '1'
  if (Get-Command chezmoi -ErrorAction SilentlyContinue) {
    try {
      $updateOutput = chezmoi update 2>&1
      if ($LASTEXITCODE -eq 0) {
        if ($updateOutput) { Write-Verbose $updateOutput }
        . $PROFILE
        return
      } else {
        Write-Warning "chezmoi update failed:`n$updateOutput"
      }
    } catch {
      Write-Warning "chezmoi update failed: $_"
    }
  }
}

# chezmoi environment-variable
try { $env:CHEZMOI_SOURCE_DIR = (chezmoi source-path) } catch {}

# Set default editors
function Edit-File {
  param([Parameter(Mandatory)] [string]$Path)
  $editor = $env:EDITOR
  if (-not $editor) {
    if (Get-Command code -ErrorAction SilentlyContinue)      { $editor = 'code' }
    elseif (Get-Command 'notepad++' -ErrorAction SilentlyContinue) { $editor = 'notepad++' }
    else                                                     { $editor = 'notepad' }
  }
  & $editor $Path
}

# --- Load shortcuts from YAML ---
$Shortcuts = @(
{{ $data := (include "common/shortcuts.yml" | fromYaml) }}
{{ range $data }}
    [pscustomobject]@{
        name = "{{ .name }}"
        cat  = "{{ .cat }}"
        desc = "{{ .desc }}"
        cmd  = {{- if and (hasKey .cmd "win")   (eq $.chezmoi.os "windows") -}} '{{ index .cmd "win" }}'
       {{- else if and (hasKey .cmd "linux") (eq $.chezmoi.os "linux")   -}} '{{ index .cmd "linux" }}'
       {{- else if hasKey .cmd "both" -}} '{{ index .cmd "both" }}'
       {{- else -}} '' {{- end }}
    };
{{ end }}
)

# --- Register shortcut functions ---
foreach ($s in $Shortcuts) {
    if ([string]::IsNullOrWhiteSpace($s.cmd)) { continue }
    Set-Item -Path "function:$($s.name)" -Value ([scriptblock]::Create($s.cmd)) -Force
}

# --- Overview: shortcuts [CATEGORY] ---
function shortcuts {
    param([string]$Category)
    $Shortcuts
      | Where-Object { $_.cmd -and (!$Category -or $_.cat -eq $Category) }
      | Sort-Object cat,name
      | Select-Object name,cat,desc,cmd
      | Format-Table -AutoSize
}

# --- Git helper: allg (add + status + commit + push) ---
function allg {
    param(
        [string]$Message
    )

    if (-not (Test-Path ".git")) {
        Write-Host "Not inside a Git repository."
        return
    }

    git add -A
    git status

    if (-not $Message) {
        $Message = Read-Host "Enter commit message"
    }

    if ([string]::IsNullOrWhiteSpace($Message)) {
        Write-Host "Aborted: empty commit message."
        return
    }

    git commit -m "$Message"

    # get current branch
    $branch = git rev-parse --abbrev-ref HEAD

    # check if upstream exists 
    $null = git rev-parse --symbolic-full-name --abbrev-ref '@{u}' 2>$null
    if ($LASTEXITCODE -ne 0) {
        git push -u origin $branch
    } else {
        git push
    }
}

try { Start-Service ssh-agent -ErrorAction SilentlyContinue | Out-Null } catch {}

function Show-DotfilesVersion {
  $version = 'unknown'
  $branch = $null

  if ($env:DOTFILES -and (Test-Path (Join-Path $env:DOTFILES '.git'))) {
    if (Get-Command git -ErrorAction SilentlyContinue) {
      try {
        $version = git -C $env:DOTFILES rev-parse --short HEAD 2>$null
        $branch  = git -C $env:DOTFILES rev-parse --abbrev-ref HEAD 2>$null
      } catch {}
    }
  }

  if ($branch -and $branch -ne 'HEAD') {
    $version = "$branch@$version"
  }

  Write-Host "Dotfiles version (Windows): $version"
}

Show-DotfilesVersion
Write-Host "Profile loaded. 'shortcuts' lists everything, 'shortcuts DIRS' filters."
